#!/usr/bin/python3 -u

import os
import sys
import re
import argparse
import socket
from datetime import datetime
import tinkerforge_util as tfutil  # sudo apt install python3-tinkerforge-util

NAME_1_PLACEHOLDER = b'Industrial Dual Analog In Bricklet 2.0'
NAME_2_PLACEHOLDER = b'Ethernet Master Extension (without PoE)'
NAME_3_PLACEHOLDER = b'Board-to-Board Connector 30 Pin (Brick Bottom 4.85mm)'
NAME_4a_PLACEHOLDER = b'Starter Kit: Server Room Monitoring (Assembly Kit,'
NAME_4b_PLACEHOLDER = b'None-Stand-Alone)'

NAME_1_MAX_LENGTH = 35
NAME_2_MAX_LENGTH = 50
NAME_3_MAX_LENGTH = 55

SKU_PLACEHOLDER = b'556677'

DATE_PLACEHOLDER = b'1999-10-12'

UID_PLACEHOLDER = b'XXYYZZ'

VERSION_PLACEHOLDER = b'2.17.5'

EAN13_PLACEHOLDER = b'123456789012'

COPIES_FORMAT = '^C{0}\r'


SKU_TO_GTIN = {
    "27": "4251640700003",
    "68": "4251640700010",
    "610": "4251640700027",
    "618": "4251640700034",
    "28": "4251640700041",
    "29": "4251640700058",
    "210": "4251640700065",
    "212": "4251640700072",
    "25": "4251640700089",
    "26": "4251640700096",
    "213": "4251640700102",
    "215": "4251640700119",
    "216": "4251640700126",
    "217": "4251640700133",
    "11": "4251640700140",
    "13": "4251640700157",
    "14": "4251640700164",
    "15": "4251640700171",
    "41": "4251640700188",
    "620": "4251640700195",
    "621": "4251640700201",
    "619": "4251640700218",
    "12": "4251640700225",
    "22": "4251640700232",
    "611": "4251640700249",
    "622": "4251640700256",
    "220": "4251640700263",
    "625": "4251640700270",
    "221": "4251640700287",
    "223": "4251640700294",
    "224": "4251640700300",
    "225": "4251640700317",
    "650": "4251640700324",
    "651": "4251640700331",
    "623": "4251640700348",
    "626": "4251640700355",
    "627": "4251640700362",
    "628": "4251640700379",
    "629": "4251640700386",
    "52": "4251640700393",
    "54": "4251640700409",
    "32": "4251640700416",
    "643": "4251640700423",
    "644": "4251640700430",
    "33": "4251640700447",
    "645": "4251640700454",
    "647": "4251640700461",
    "652": "4251640700478",
    "222": "4251640700485",
    "227": "4251640700492",
    "658": "4251640700508",
    "659": "4251640700515",
    "660": "4251640700522",
    "661": "4251640700539",
    "71": "4251640700546",
    "72": "4251640700553",
    "73": "4251640700560",
    "74": "4251640700577",
    "OLD56": "4251640700584",
    "75": "4251640700591",
    "78": "4251640700607",
    "77": "4251640700614",
    "34": "4251640700621",
    "710": "4251640700638",
    "711": "4251640700645",
    "712": "4251640700652",
    "713": "4251640700669",
    "714": "4251640700676",
    "715": "4251640700683",
    "716": "4251640700690",
    "717": "4251640700706",
    "719": "4251640700713",
    "718": "4251640700720",
    "720": "4251640700737",
    "721": "4251640700744",
    "59": "4251640700751",
    "722": "4251640700768",
    "228": "4251640700775",
    "226": "4251640700782",
    "723": "4251640700799",
    "669": "4251640700805",
    "670": "4251640700812",
    "724": "4251640700829",
    "671": "4251640700836",
    "229": "4251640700843",
    "230": "4251640700850",
    "232": "4251640700867",
    "233": "4251640700874",
    "234": "4251640700881",
    "235": "4251640700898",
    "236": "4251640700904",
    "237": "4251640700911",
    "238": "4251640700928",
    "239": "4251640700935",
    "240": "4251640700942",
    "241": "4251640700959",
    "242": "4251640700966",
    "725": "4251640700973",
    "OLD58": "4251640700980",
    "726": "4251640700997",
    "727": "4251640701000",
    "728": "4251640701017",
    "729": "4251640701024",
    "731": "4251640701031",
    "730": "4251640701048",
    "732": "4251640701055",
    "733": "4251640701062",
    "736": "4251640701079",
    "734": "4251640701086",
    "735": "4251640701093",
    "678": "4251640701109",
    "679": "4251640701116",
    "680": "4251640701123",
    "681": "4251640701130",
    "682": "4251640701147",
    "57": "4251640701154",
    "683": "4251640701161",
    "510": "4251640701178",
    "511": "4251640701185",
    "512": "4251640701192",
    "513": "4251640701208",
    "514": "4251640701215",
    "737": "4251640701222",
    "35": "4251640701239",
    "689": "4251640701246",
    "690": "4251640701253",
    "691": "4251640701260",
    "692": "4251640701277",
    "738": "4251640701284",
    "516": "4251640701291",
    "695": "4251640701307",
    "696": "4251640701314",
    "697": "4251640701321",
    "698": "4251640701338",
    "699": "4251640701345",
    "6101": "4251640701352",
    "6100": "4251640701369",
    "244": "4251640701376",
    "243": "4251640701383",
    "246": "4251640701390",
    "6107": "4251640701406",
    "17": "4251640701413",
    "6109": "4251640701420",
    "6110": "4251640701437",
    "6112": "4251640701444",
    "6113": "4251640701451",
    "517": "4251640701468",
    "6114": "4251640701475",
    "6116": "4251640701482",
    "6117": "4251640701499",
    "6120": "4251640701505",
    "6121": "4251640701512",
    "6122": "4251640701529",
    "6118": "4251640701536",
    "6119": "4251640701543",
    "6123": "4251640701550",
    "6124": "4251640701567",
    "6125": "4251640701574",
    "518": "4251640701581",
    "519": "4251640701598",
    "250": "4251640701604",
    "259": "4251640701611",
    "251": "4251640701628",
    "256": "4251640701635",
    "260": "4251640701642",
    "18": "4251640701659",
    "258": "4251640701666",
    "249": "4251640701673",
    "6126": "4251640701680",
    "253": "4251640701697",
    "6127": "4251640701703",
    "6128": "4251640701710",
    "255": "4251640701727",
    "254": "4251640701734",
    "740": "4251640701741",
    "741": "4251640701758",
    "742": "4251640701765",
    "743": "4251640701772",
    "262": "4251640701789",
    "6129": "4251640701796",
    "6130": "4251640701802",
    "6131": "4251640701819",
    "6132": "4251640701826",
    "744": "4251640701833",
    "263": "4251640701840",
    "264": "4251640701857",
    "265": "4251640701864",
    "266": "4251640701871",
    "KIT55": "4251640701888",
    "745": "4251640701895",
    "6134": "4251640701901",
    "268": "4251640701918",
    "273": "4251640701925",
    "274": "4251640701932",
    "275": "4251640701949",
    "GROUP59": "4251640701956",
    "GROUP518": "4251640701963",
    "56": "4251640701970",
    "525": "4251640701987",
    "KIT56": "4251640701994",
    "36": "4251640702007",
    "271": "4251640702014",
    "270": "4251640702021",
    "19": "4251640702038",
    "746": "4251640702045",
    "747": "4251640702052",
    "748": "4251640702069",
    "749": "4251640702076",
    "277": "4251640702083",
    "276": "4251640702090",
    "6136": "4251640702106",
    "6137": "4251640702113",
    "6138": "4251640702120",
    "6139": "4251640702137",
    "6140": "4251640702144",
    "283": "4251640702151",
    "282": "4251640702168",
    "272": "4251640702175",
    "267": "4251640702182",
    "278": "4251640702199",
    "285": "4251640702205",
    "750": "4251640702212",
    "751": "4251640702229",
    "752": "4251640702236",
    "753": "4251640702243",
    "291": "4251640702250",
    "286": "4251640702267",
    "289": "4251640702274",
    "295": "4251640702281",
    "292": "4251640702298",
    "294": "4251640702304",
    "288": "4251640702311",
    "296": "4251640702328",
    "754": "4251640702335",
    "755": "4251640702342",
    "756": "4251640702359",
    "6147": "4251640702366",
    "6148": "4251640702373",
    "757": "4251640702380",
    "290": "4251640702397",
    "2100": "4251640702403",
    "2104": "4251640702410",
    "2103": "4251640702427",
    "2102": "4251640702434",
    "2101": "4251640702441",
    "2106": "4251640702458",
    "293": "4251640702465",
    "2105": "4251640702472",
    "284": "4251640702489",
    "2109": "4251640702496",
    "2110": "4251640702502",
    "2111": "4251640702519",
    "2108": "4251640702526",
    "2107": "4251640702533",
    "758": "4251640702540",
    "760": "4251640702557",
    "759": "4251640702564",
    "780": "4251640702571",
    "781": "4251640702588",
    "782": "4251640702595",
    "783": "4251640702601",
    "784": "4251640702618",
    "789": "4251640702625",
    "791": "4251640702632",
    "297": "4251640702649",
    "2115": "4251640702656",
    "2117": "4251640702663",
    "2125": "4251640702670",
    "2119": "4251640702687",
    "2122": "4251640702694",
    "2120": "4251640702700",
    "2121": "4251640702717",
    "2116": "4251640702724",
    "2124": "4251640702731",
    "2114": "4251640702748",
    "298": "4251640702755",
    "2112": "4251640702762",
    "2123": "4251640702779",
    "2113": "4251640702786",
    "2118": "4251640702793",
    "761": "4251640702809",
    "6149": "4251640702816",
    "6150": "4251640702823",
    "6151": "4251640702830",
    "6152": "4251640702847",
    "6153": "4251640702854",
    "767": "4251640702861",
    "768": "4251640702878",
    "769": "4251640702885",
    "770": "4251640702892",
    "771": "4251640702908",
    "612": "4251640702915",
    "762": "4251640702922",
    "763": "4251640702939",
    "764": "4251640702946",
    "766": "4251640702953",
    "765": "4251640702960",
    "55": "4251640702977",
    "524": "4251640702984",
    "523": "4251640702991",
    "522": "4251640703004",
    "521": "4251640703011",
    "642": "4251640703028",
    "656": "4251640703035",
    "657": "4251640703042",
    "662": "4251640703059",
    "672": "4251640703066",
    "673": "4251640703073",
    "674": "4251640703080",
    "688": "4251640703097",
    "6115": "4251640703103",
    "694": "4251640703110",
    "6102": "4251640703127",
    "6103": "4251640703134",
    "6104": "4251640703141",
    "6105": "4251640703158",
    "6106": "4251640703165",
    "6108": "4251640703172",
    "6135": "4251640703189",
    "6154": "4251640703196",
    "6167": "4251640703202",
    "6168": "4251640703219",
    "6169": "4251640703226",
    "6170": "4251640703233",
    "6171": "4251640703240",
    "6172": "4251640703257",
    "6173": "4251640703264",
    "6174": "4251640703271",
    "6165": "4251640703288",
    "6163": "4251640703295",
    "6162": "4251640703301",
    "6161": "4251640703318",
    "6160": "4251640703325",
    "2142": "4251640703332",
    "2143": "4251640703349",
    "526": "4251640703356",
    "528": "4251640703363",
    "527": "4251640703370",
    "529": "4251640703387",
    "530": "4251640703394",
    "531": "4251640703400",
    "532": "4251640703417",
    "773": "4251640703424",
    "772": "4251640703431",
    "774": "4251640703448",
    "775": "4251640703455",
    "2130": "4251640703462",
    "2131": "4251640703479",
    "534": "4251640703486",
    "535": "4251640703493",
    "536": "4251640703509",
    "537": "4251640703516",
    "776": "4251640703523",
    "2137": "4251640703530",
    "2132": "4251640703547",
    "2139": "4251640703554",
    "2127": "4251640703561",
    "2138": "4251640703578",
    "2145": "4251640703585",
    "2144": "4251640703592",
    "2147": "4251640703608",
    "2146": "4251640703615",
    "2148": "4251640703622",
    "776": "4251640703639",
    "777": "4251640703646",
    "778": "4251640703653",
    "111": "4251640703660",
    "112": "4251640703677",
    "6133": "4251640703684",
    "2149": "4251640703691",
    "2150": "4251640703707",
    "2151": "4251640703714",
    "2152": "4251640703721",
    "2153": "4251640703738",
    "2154": "4251640703745",
    "2155": "4251640703752",
    "6177": "4251640703769",
    "6176": "4251640703776",
    "6175": "4251640703783",
    "779": "4251640703790",
    "780": "4251640703806",
    "6178": "4251640703813",
    "6179": "4251640703820",
    "6180": "4251640703837",
    "781": "4251640703844",
    "782": "4251640703851",
    "61": "4251640703868",
    "62": "4251640703875",
    "63": "4251640703882",
    "64": "4251640703899",
    "783": "4251640703905",
    "533": "4251640703912",
    "534": "4251640703929",
    "535": "4251640703936",
    "536": "4251640703943",
    "537": "4251640703950",
    "538": "4251640703967",
    "2162": "4251640703974",
    "2160": "4251640703981",
    "6181": "4251640703998",
    "6182": "4251640704001",
    "6183": "4251640704018",
    "6184": "4251640704025",
    "2161": "4251640704032",
    "WARP-CB-11KW": "4251640704049",
    "WARP-CB-22KW": "4251640704056",
    "WARP-CB-11KW-CEE": "4251640704063",
    "WARP-CB-22KW-CEE": "4251640704070",
    "WARP-CS-11KW": "4251640704087",
    "WARP-CS-22KW": "4251640704094",
    "WARP-CS-11KW-CEE": "4251640704100",
    "WARP-CS-22KW-CEE": "4251640704117",
    "WARP-CP-11KW": "4251640704124",
    "WARP-CP-22KW": "4251640704131",
    "WARP-CP-11KW-CEE": "4251640704148",
    "WARP-CP-22KW-CEE": "4251640704155",
    "6185": "4251640704162",
    "6186": "4251640704179",
    "WARP-T2-S": "4251640704186",
    "WARP-T2-DS": "4251640704193",
    "WARP-T2-CC-5M-32A": "4251640704209",
    "WARP-T2-5M-32A": "4251640704216",
    "WARP-T2-5M-16A": "4251640704223",
    "WARP-CON-4P-63A": "4251640704230",
    "WARP-RCCB-B-4P-40A": "4251640704247",
    "WARP-PS-12V": "4251640704254",
    "WARP-METER-3PH-MID": "4251640704261",
    "WARP-DC-PROTECT": "4251640704278",
    "WARP-CP-OEM": "4251640704285",
    "WARP‐CB‐11KW‐50": "4251640704292",
    "WARP‐CB‐11KW‐75": "4251640704308",
    "WARP‐CB‐22KW‐50": "4251640704315",
    "WARP‐CB‐22KW‐75": "4251640704322",
    "WARP‐CB‐11KW‐50-CEE": "4251640704339",
    "WARP‐CB‐11KW‐75-CEE": "4251640704346",
    "WARP‐CB‐22KW‐50-CEE": "4251640704353",
    "WARP‐CB‐22KW‐75-CEE": "4251640704360",
    "WARP‐CS‐11KW‐50": "4251640704377",
    "WARP‐CS‐11KW‐75": "4251640704384",
    "WARP‐CS‐22KW‐50": "4251640704391",
    "WARP‐CS‐22KW‐75": "4251640704407",
    "WARP‐CS‐11KW‐50-CEE": "4251640704414",
    "WARP‐CS‐11KW‐75-CEE": "4251640704421",
    "WARP‐CS‐22KW‐50-CEE": "4251640704438",
    "WARP‐CS‐22KW‐75-CEE": "4251640704445",
    "WARP‐CP‐11KW‐50": "4251640704452",
    "WARP‐CP‐11KW‐75": "4251640704469",
    "WARP‐CP‐22KW‐50": "4251640704476",
    "WARP‐CP‐11KW‐50-CEE": "4251640704483",
    "WARP‐CP‐11KW‐75-CEE": "4251640704490",
    "WARP‐CP‐22KW‐50-CEE": "4251640704506",
    "WARP‐CP‐22KW‐75-CEE": "4251640704513",
    "WARP‐CP‐22KW‐75": "4251640704520",
    "2157": "4251640704537",
    "2156": "4251640704544",
    "6187": "4251640704551",
    "6188": "4251640704568",
    "2159": "4251640704575",
    "113": "4251640704582",
    "WARP-T2-75M-32A": "4251640704599",
    "WARP-T2-75M-16A": "4251640704605",
    "WARP-CASE": "4251640704612",
    "6189": "4251640704629",
    "6190": "4251640704636",
    "6191": "4251640704643",
    "6192": "4251640704650",
    "2164": "4251640704667",
    "2165": "4251640704674",
    "2166": "4251640704681",
    "115": "4251640704698",
    "WARP-S-M6-3MM": "4251640704704",
    "116": "4251640704711",
    "WARP-AP-B": "4251640704728",
    "WARP-AP-S": "4251640704735",
    "WARP-AP-P": "4251640704742",
    "WARP-M": "4251640704759",
    "WARP-F": "4251640704766",
    "WARP2‐CB‐11KW‐50": "4251640704773",
    "WARP2‐CB‐11KW‐75": "4251640704780",
    "WARP2‐CB‐22KW‐50": "4251640704797",
    "WARP2‐CB‐22KW‐75": "4251640704803",
    "WARP2‐CS‐11KW‐50": "4251640704810",
    "WARP2‐CS‐11KW‐75": "4251640704827",
    "WARP2‐CS‐22KW‐50": "4251640704834",
    "WARP2‐CS‐22KW‐75": "4251640704841",
    "WARP2‐CP‐11KW‐50": "4251640704858",
    "WARP2‐CP‐11KW‐75": "4251640704865",
    "WARP2‐CP‐22KW‐50": "4251640704872",
    "WARP2‐CP‐22KW‐75": "4251640704889",
    "WARP2-11KW-1M": "4251640704896",
    "WARP2-22KW-1M": "4251640704902",
    "WARP2-11KW-CEE": "4251640704919",
    "WARP2-22KW-CEE": "4251640704926",
    "6193": "4251640704933",
    "WARP-T2-T2": "4251640704940",
    "WARP2-METER-3PH-MID": "4251640704957",
    "WARP2-NFC-CARD": "4251640704964",
    "WARP-REP-KIT": "4251640704971",
    "6194": "4251640704988",
    "6195": "4251640704995",
    "WARP-SDM630-CABLE": "4251640705008",
    "42": "4251640705015",
    "632": "4251640705022",
    "81": "4251640705039",
    "82": "4251640705046",
    "83": "4251640705053",
    "84": "4251640705060",
    "85": "4251640705077",
    "86": "4251640705084",
    "87": "4251640705091",
    "88": "4251640705107",
    "89": "4251640705114",
    "630": "4251640705121",
    "631": "4251640705138",
    "633": "4251640705145",
    "653": "4251640705152",
    "654": "4251640705169",
    "664": "4251640705176",
    "665": "4251640705183",
    "666": "4251640705190",
    "667": "4251640705206",
    "668": "4251640705213",
    "635": "4251640705220",
    "636": "4251640705237",
    "637": "4251640705244",
    "638": "4251640705251",
    "639": "4251640705268",
    "655": "4251640705275",
    "2171": "4251640705282",
    "WARP-STAND-1": "4251640705299",
    "WARP-STAND-2": "4251640705305",
    "6196": "4251640705312",
    "6197": "4251640705329",
    "WARP-MP": "4251640705336",
    "WARP-T2-DS-CURVED": "4251640705343",
    "WARP-HOOK": "4251640705350",
    "WARP-T2-DS-HOOK": "4251640705367",
    "WARP-STAND-2-POWDER-COATED": "4251640705374",
    "WARP-EM": "4251640705381",
    "WARP2-METER-SDM72DMV2": "4251640705398",
    "WARP-EM-PHSW": "4251640705404",
    "WARP-CB-LTE": "4251640705411",
    "WARP2-METER-SDM630MCTV2": "4251640705428",
    "WARP2-ESCT-T24-100A5A": "4251640705435",
    "WARP2‐CB‐11KW‐50-PC": "4251640705442",
    "WARP2‐CB‐11KW‐75-PC": "4251640705459",
    "WARP2‐CB‐22KW‐50-PC": "4251640705466",
    "WARP2‐CB‐22KW‐75-PC": "4251640705473",
    "WARP2‐CS‐11KW‐50-PC": "4251640705480",
    "WARP2‐CS‐11KW‐75-PC": "4251640705497",
    "WARP2‐CS‐22KW‐50-PC": "4251640705503",
    "WARP2‐CS‐22KW‐75-PC": "4251640705510",
    "WARP2‐CP‐11KW‐50-PC": "4251640705527",
    "WARP2‐CP‐11KW‐75-PC": "4251640705534",
    "WARP2‐CP‐22KW‐50-PC": "4251640705541",
    "WARP2‐CP‐22KW‐75-PC": "4251640705558",
    "WARP-STAND-LOCK": "4251640705565",
    "WARP-STAND-1-PC": "4251640705572",
    "WARP2-RJ45-ETH-CABLE": "4251640705589",
    "WARP3‐CB‐11KW‐50": "4251640705596",
    "WARP3‐CB‐11KW‐75": "4251640705602",
    "WARP3‐CB‐22KW‐50": "4251640705619",
    "WARP3‐CB‐22KW‐75": "4251640705626",
    "WARP3‐CS‐11KW‐50": "4251640705633",
    "WARP3‐CS‐11KW‐75": "4251640705640",
    "WARP3‐CS‐22KW‐50": "4251640705657",
    "WARP3‐CS‐22KW‐75": "4251640705664",
    "WARP3‐CP‐11KW‐50": "4251640705671",
    "WARP3‐CP‐11KW‐75": "4251640705688",
    "WARP3‐CP‐22KW‐50": "4251640705695",
    "WARP3‐CP‐22KW‐75": "4251640705701",
    "WARP3‐CB‐11KW‐50-PC": "4251640705718",
    "WARP3‐CB‐11KW‐75-PC": "4251640705725",
    "WARP3‐CB‐22KW‐50-PC": "4251640705732",
    "WARP3‐CB‐22KW‐75-PC": "4251640705749",
    "WARP3‐CS‐11KW‐50-PC": "4251640705756",
    "WARP3‐CS‐11KW‐75-PC": "4251640705763",
    "WARP3‐CS‐22KW‐50-PC": "4251640705770",
    "WARP3‐CS‐22KW‐75-PC": "4251640705787",
    "WARP3‐CP‐11KW‐50-PC": "4251640705794",
    "WARP3‐CP‐11KW‐75-PC": "4251640705800",
    "WARP3‐CP‐22KW‐50-PC": "4251640705817",
    "WARP3‐CP‐22KW‐75-PC": "4251640705824",
    "WARP3-METER-3PH-MID": "4251640705831",
    "6198": "4251640705848",
    "WARP-CON-2P-63A": "4251640705855",
    "WARP3-FUSE-2A": "4251640705862",
    "WARP3-DC-PROTECT": "4251640705879",
    "WARP3-CASE": "4251640705886",
    "WARP3-CABLE-HARNESS": "4251640705893",
    "WARP-DSZ15-CABLE": "4251640705909",
    "WARP3-CASE-PC": "4251640705916",
    "WARP3-TERMINAL-BLOCKS": "4251640705923",
    "WARP3-ISO-SET": "4251640705930",
    "WARP3-PB-LED": "4251640705947",
    "117": "4251640705954",
    "2177": "4251640705961",
}


def print_label(name, sku, date, uid, version, type_, copies, stdout):
    # check copies
    if copies < 1 or copies > 20:
        raise Exception('Invalid copies: {0}'.format(copies))

    # check date
    datetime.strptime(date, '%Y-%m-%d')

    # check version
    if re.match(r'^(\d+.\d+.\d+|-)$', version) == None:
        raise Exception('Invalid version: {0}'.format(version))

    # read EZPL file
    if len(name) <= NAME_1_MAX_LENGTH:
        template_filename = 'label1_{0}.prn'.format(type_)
        name_placeholders = [NAME_1_PLACEHOLDER]
        name_parts = [name]
    elif len(name) <= NAME_2_MAX_LENGTH:
        template_filename = 'label2_{0}.prn'.format(type_)
        name_placeholders = [NAME_2_PLACEHOLDER]
        name_parts = [name]
    elif len(name) <= NAME_3_MAX_LENGTH:
        template_filename = 'label3_{0}.prn'.format(type_)
        name_placeholders = [NAME_3_PLACEHOLDER]
        name_parts = [name]
    else:
        template_filename = 'label4_{0}.prn'.format(type_)
        name_placeholders = [NAME_4a_PLACEHOLDER, NAME_4b_PLACEHOLDER]
        name_parts = [[]]

        for name_part in name.split(' '):
            if len(' '.join(name_parts[-1] + [name_part])) <= NAME_3_MAX_LENGTH:
                name_parts[-1].append(name_part)
            else:
                name_parts.append([name_part])

        name_parts = [' '.join(x) for x in name_parts]

        if len(name_parts) < 2:
            name_parts.append('')

    with open(os.path.join(os.path.dirname(os.path.realpath(__file__)), template_filename), 'rb') as f:
        template = f.read()

    if b'^D0\r' not in template or b'^D0\r' not in template:
        raise Exception('EZPL file is using wrong print mode setting')

    template = template.replace(b'^D0\r', b'^D1\r')

    if template.find(b'^H13\r') < 0:
        raise Exception('EZPL file is using wrong darkness setting')

    if template.find(b'^O1\r') < 0:
        raise Exception('EZPL file is using wrong dispenser setting')

    if template.find(b'^E8\r') < 0:
        raise Exception('EZPL file is using wrong tear-off setting')

    # patch name
    for name_placeholder, name_part in zip(name_placeholders, name_parts):
        if template.find(name_placeholder) < 0:
            raise Exception('Name placeholder missing in EZPL file')

        template = template.replace(name_placeholder, name_part.encode('latin1'))

    # patch SKU
    if type_ == 'normal':
        if template.find(SKU_PLACEHOLDER) < 0:
            raise Exception('SKU placeholder missing in EZPL file')

        template = template.replace(SKU_PLACEHOLDER, sku.encode('latin1'))

    # patch date
    if type_ == 'normal':
        if template.find(DATE_PLACEHOLDER) < 0:
            raise Exception('Date placeholder missing in EZPL file')

        template = template.replace(DATE_PLACEHOLDER, date.encode('ascii'))

    # patch UID
    if type_ == 'normal':
        if template.find(UID_PLACEHOLDER) < 0:
            raise Exception('UID placeholder missing in EZPL file')

        template = template.replace(UID_PLACEHOLDER, uid.encode('ascii'))

    # patch version
    if type_ == 'normal':
        if template.find(VERSION_PLACEHOLDER) < 0:
            raise Exception('Version placeholder missing in EZPL file')

        template = template.replace(VERSION_PLACEHOLDER, version.encode('ascii'))

    # patch EAN13
    if type_ == 'ean13':
        if template.find(EAN13_PLACEHOLDER) < 0:
            raise Exception('EAN13 placeholder missing in EZPL file')

        template = template.replace(EAN13_PLACEHOLDER, SKU_TO_GTIN[sku].encode('ascii'))

    # patch copies
    copies_command = COPIES_FORMAT.format(1).encode('ascii')

    if template.find(copies_command) < 0:
        raise Exception('Copies command missing in EZPL file')

    template = template.replace(copies_command, COPIES_FORMAT.format(copies).encode('ascii'))

    # print label
    if stdout:
        sys.stdout.buffer.write(template)
        sys.stdout.buffer.flush()
    else:
        with socket.create_connection((tfutil.get_tf_printer_host('esd-bag'), 9100)) as s:
            s.send(template)


def main():
    parser = argparse.ArgumentParser()

    parser.add_argument('name')
    parser.add_argument('sku')
    parser.add_argument('date')
    parser.add_argument('uid')
    parser.add_argument('version')
    parser.add_argument('-t', '--type', choices=['normal', 'ean13'], default='normal')
    parser.add_argument('-c', '--copies', type=int, default=1)
    parser.add_argument('-s', '--stdout', action='store_true')

    args = parser.parse_args()

    assert args.copies > 0

    print_label(args.name, args.sku, args.date, args.uid, args.version, args.type, args.copies, args.stdout)


if __name__ == '__main__':
    main()
